<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Automatisme - Évaluation des Compétences</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Google Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Configuration Material Symbols */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
            line-height: 1;
            user-select: none;
        }
        
        /* Classes utilitaires pour tailles d'icônes */
        .icon-sm { font-size: 18px !important; }
        .icon-md { font-size: 20px !important; }
        .icon-lg { font-size: 24px !important; }
        .icon-xs { font-size: 16px !important; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans min-h-screen pb-20">

    <div id="app">
        <header id="app-header" class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm"></header>
        <main id="app-content" class="max-w-5xl mx-auto px-4 py-8 sm:px-6 lg:px-8"></main>
    </div>

    <script>
        // --- 1. DONNÉES & CONFIGURATION ---
        // (Les données restent identiques)
        const SKILLS_DATA = [
          {
            id: "1", title: "1. Spécification des Systèmes", description: "Comprendre le besoin, modéliser le procédé et définir les exigences fonctionnelles.", icon: "menu_book",
            subSkills: [
              { id: "1.1", title: "Analyse Fonctionnelle et Modélisation", description: "Compréhension du besoin client, GRAFCET, SysML, SADT." },
              { id: "1.2", title: "Sûreté de Fonctionnement", description: "Analyse des risques (APR, HAZOP), SIL/PL." },
              { id: "1.3", title: "Conformité Normative", description: "Normes industrielles (IEC, ISA) et réglementations." }
            ]
          },
          {
            id: "2", title: "2. Conception Technique", description: "Définir la structure matérielle, logicielle et réseau.", icon: "memory",
            subSkills: [
              { id: "2.1", title: "Architecture Système (API/DCS)", description: "Architecture centralisée/distribuée, choix matériel." },
              { id: "2.2", title: "Réseaux Industriels (OT)", description: "Bus de terrain, Ethernet industriel, Protocoles." },
              { id: "2.3", title: "Instrumentation", description: "Capteurs, actionneurs, chaînes de mesure." },
              { id: "2.4", title: "Conception Électrotechnique", description: "Schémas électriques, armoires, CAO." },
              { id: "2.5", title: "Cybersécurité by Design", description: "Segmentation réseau, IEC 62443." }
            ]
          },
          {
            id: "3", title: "3. Développement Logiciel", description: "Coder et paramétrer les applications de contrôle.", icon: "code",
            subSkills: [
              { id: "3.1", title: "Programmation Automates", description: "IEC 61131-3 (Ladder, ST, SFC...)." },
              { id: "3.2", title: "Configuration SNCC/DCS", description: "Systèmes distribués complexes." },
              { id: "3.3", title: "Développement IHM/SCADA", description: "Supervision, ergonomie, gestion d'alarmes." },
              { id: "3.4", title: "Régulation (PID)", description: "Boucles de régulation, réglages." },
              { id: "3.5", title: "Robotique", description: "Intégration robots/cobots, motion control." },
              { id: "3.6", title: "Versioning", description: "Git, SVN, gestion de configuration." }
            ]
          },
          {
            id: "4", title: "4. Intégration des Systèmes", description: "Assurer l'interopérabilité et la connexion.", icon: "hub",
            subSkills: [
              { id: "4.1", title: "Informatique Industrielle", description: "Bases de données (SQL), Scripts, Virtualisation." },
              { id: "4.2", title: "Intégration MES/ERP", description: "Passerelles IT/OT." },
              { id: "4.3", title: "IIoT & Edge", description: "MQTT, Node-RED, passerelles IoT." },
              { id: "4.4", title: "Infrastructure OT", description: "Switches, VLANs, Serveurs." }
            ]
          },
          {
            id: "5", title: "5. Validation Technique", description: "Vérifier la conformité par tests.", icon: "check_circle",
            subSkills: [
              { id: "5.1", title: "Stratégie de Test", description: "Plans de validation." },
              { id: "5.2", title: "Simulation", description: "Jumeaux numériques, Virtual Commissioning." },
              { id: "5.3", title: "Tests FAT", description: "Acceptation en usine." },
              { id: "5.4", title: "Qualification", description: "QI/QO (Pharma/Process)." }
            ]
          },
          {
            id: "6", title: "6. Mise en Service", description: "Installation et démarrage sur site.", icon: "play_circle",
            subSkills: [
              { id: "6.1", title: "Configuration Terrain", description: "Calibration, variateurs." },
              { id: "6.2", title: "I/O Checkout", description: "Tests de boucles, câblage." },
              { id: "6.3", title: "Tests SAT", description: "Acceptation sur site, démarrage." },
              { id: "6.4", title: "Documentation & Formation", description: "DOE, transfert de compétences." }
            ]
          },
          {
            id: "7", title: "7. Maintenance", description: "MCO et dépannage.", icon: "build",
            subSkills: [
              { id: "7.1", title: "Diagnostic", description: "Recherche de pannes." },
              { id: "7.2", title: "Préventif/Correctif", description: "Plans de maintenance." },
              { id: "7.3", title: "Gestion des Modifications", description: "Travaux neufs mineurs." },
              { id: "7.4", title: "Maintenance Sécurité", description: "Patching, sauvegardes." }
            ]
          },
          {
            id: "8", title: "8. Optimisation", description: "Amélioration continue.", icon: "trending_up",
            subSkills: [
              { id: "8.1", title: "Performance (KPI)", description: "TRS, analyse de données." },
              { id: "8.2", title: "Efficacité Énergétique", description: "Optimisation conso." },
              { id: "8.3", title: "Contrôle Avancé", description: "APC, modèles prédictifs." },
              { id: "8.4", title: "Revamping", description: "Gestion de l'obsolescence." }
            ]
          },
          {
            id: "9", title: "9. Gestion de Projet", description: "Pilotage et organisation.", icon: "work",
            subSkills: [
              { id: "9.1", title: "Méthodologie", description: "Cycle V, Agile." },
              { id: "9.2", title: "Planification", description: "Délais, ressources." },
              { id: "9.3", title: "Budget", description: "Chiffrage, suivi financier." },
              { id: "9.4", title: "Coordination", description: "Management transversal." }
            ]
          },
          {
            id: "10", title: "10. Soft Skills", description: "Humain et relationnel.", icon: "group",
            subSkills: [
              { id: "10.1", title: "Relation Client", description: "Posture conseil." },
              { id: "10.2", title: "Communication", description: "Reporting, synthèse." },
              { id: "10.3", title: "Anglais Technique", description: "Oral et écrit." },
              { id: "10.4", title: "Sécurité (HSE)", description: "Culture sécurité chantier." }
            ]
          }
        ];

        const LEVEL_DETAILS = [
          { label: "Pas d'expérience", hours: "0h", desc: "Jamais pratiqué" },
          { label: "Initié", hours: "< 100h", desc: "Premiers acquis" },
          { label: "Intermédiaire", hours: "100-1000h", desc: "Autonome sur tâches simples" },
          { label: "Avancé", hours: "> 1000h", desc: "Maîtrise complète" }
        ];

        const MONTHS = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

        const PACE_OPTIONS = [
          { label: "Flexible", sub: "3h / sem", value: 3 },
          { label: "Dynamique", sub: "7h / sem", value: 7 },
          { label: "Accéléré", sub: "14h / sem", value: 14 },
          { label: "Intensif", sub: "21h / sem", value: 21 },
          { label: "Immersif", sub: "35h / sem", value: 35 }
        ];

        const FORMAT_OPTIONS = [
          { label: "Express", sub: "< 14h", value: "express" },
          { label: "Court", sub: "14h à 35h", value: "short" },
          { label: "Moyen", sub: "35h à 150h", value: "medium" },
          { label: "Long", sub: "> 150h", value: "long" }
        ];

        const MANUFACTURER_OPTIONS = ["Schneider Electric", "Siemens", "Rockwell Automation", "Omron", "Autre"];
        const SECTOR_OPTIONS = ["Pharmaceutique", "Infrastructure", "Défense", "Agroalimentaire", "Energie", "Autre"];

        const PRESETS = [
          {
            id: 'socle_fondamental',
            label: 'Socle fondamental',
            description: "Idéal pour découvrir le panorama des systèmes, lire un GRAFCET et comprendre les bases du Ladder.",
            skills: ['1.1', '2.1', '3.1']
          },
          {
            id: 'focus_qualif',
            label: 'Qualité',
            description: "Idéal pour valider la conformité des équipements (GAMP5, FAT/SAT) sans toucher au code.",
            skills: ['1.3', '5.1', '5.4']
          },
          {
            id: 'focus_pid',
            label: 'Régulation Process',
            description: "Idéal pour comprendre et régler les boucles de régulation complexes (Température, Pression).",
            skills: ['2.3', '3.4', '8.1']
          },
          {
            id: 'focus_diag',
            label: 'Diagnostic',
            description: "Idéal pour identifier l'origine d'une panne (capteur, câble ou automate) sans modifier le programme.",
            skills: ['2.1', '6.2', '7.1']
          },
          {
            id: 'maintenance_expert',
            label: 'Expertise Système',
            description: "Idéal pour gagner en autonomie sur le diagnostic, comprendre l'architecture et modifier le code si nécessaire.",
            skills: ['2.1', '3.1', '6.1', '7.1', '7.4'] 
          },
          {
            id: 'data_supervision',
            label: 'Data & 4.0',
            description: "Idéal pour développer des IHM avancées, remonter les données (SQL) et sécuriser les réseaux.",
            skills: ['2.5', '3.3', '4.1', '4.3', '8.1']
          },
          {
            id: 'conception_new',
            label: 'Bureau d\'Études',
            description: "Idéal pour piloter des projets neufs, dimensionner les réseaux et structurer les programmes.",
            skills: ['1.1', '2.2', '3.1', '3.4', '5.3', '9.1']
          }
        ];

        // --- 2. ÉTAT GLOBAL (STATE) ---
        const state = {
            activeTab: 0,
            selectedSkills: [], 
            skillLevels: {}, 
            preferences: { manufacturers: [], sectors: [] },
            logistics: { selectedMonths: [], weeklyHours: 0, format: '' },
            searchQuery: "",
            expandedCategories: {} 
        };

        // --- 3. HELPER ICONES ---
        function getIconHtml(name, sizeClass = 'icon-md') {
            return `<span class="material-symbols-outlined ${sizeClass}">${name}</span>`;
        }

        // --- 4. LOGIQUE MÉTIER ---

        function calculateDuration() {
            if (!state.logistics.weeklyHours || !state.logistics.format) return null;
            let minHours = 0, maxHours = 0;
            switch (state.logistics.format) {
                case 'express': minHours = 4; maxHours = 14; break;
                case 'short': minHours = 14; maxHours = 35; break;
                case 'medium': minHours = 35; maxHours = 150; break;
                case 'long': minHours = 150; maxHours = 300; break;
                default: return null;
            }
            const minWeeks = Math.ceil(minHours / state.logistics.weeklyHours);
            const maxWeeks = Math.ceil(maxHours / state.logistics.weeklyHours);
            if (state.logistics.format === 'long') return `> ${minWeeks} semaines`;
            if (minWeeks === maxWeeks) return `${minWeeks} semaine${minWeeks > 1 ? 's' : ''}`;
            return `${minWeeks} à ${maxWeeks} semaines`;
        }

        function getResolvedSelectedSkills() {
            return state.selectedSkills.map(id => {
                for (const cat of SKILLS_DATA) {
                    const sub = cat.subSkills.find(s => s.id === id);
                    if (sub) return { ...sub, categoryTitle: cat.title, categoryIcon: cat.icon };
                }
                return null;
            }).filter(Boolean);
        }

        // --- 5. MOTEUR DE RENDU INTELLIGENT (DIFFING) ---
        // Cette section est la clé pour éviter le glitch de rechargement.

        function renderDOM(containerId, htmlString) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // On crée un DOM virtuel à partir de la chaîne HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const newNodes = Array.from(doc.body.childNodes);
            const oldNodes = Array.from(container.childNodes);
            
            // On compare (diff) le conteneur actuel avec le nouveau contenu
            patchNodes(container, oldNodes, newNodes);
        }

        // Fonction récursive de mise à jour du DOM
        function patchNodes(parent, oldNodes, newNodes) {
            const maxLength = Math.max(oldNodes.length, newNodes.length);

            for (let i = 0; i < maxLength; i++) {
                const oldNode = oldNodes[i];
                const newNode = newNodes[i];

                // Cas 1: Nouveau nœud ajouté
                if (!oldNode) {
                    parent.appendChild(newNode.cloneNode(true));
                    continue;
                }

                // Cas 2: Nœud supprimé
                if (!newNode) {
                    parent.removeChild(oldNode);
                    continue;
                }

                // Cas 3: Nœuds de types différents (on remplace tout)
                if (oldNode.nodeType !== newNode.nodeType || oldNode.nodeName !== newNode.nodeName) {
                    parent.replaceChild(newNode.cloneNode(true), oldNode);
                    continue;
                }

                // Cas 4: Nœuds de texte (on met à jour le texte si différent)
                if (oldNode.nodeType === Node.TEXT_NODE) {
                    if (oldNode.textContent !== newNode.textContent) {
                        oldNode.textContent = newNode.textContent;
                    }
                    continue;
                }

                // Cas 5: Éléments HTML (div, span, input, button...)
                if (oldNode.nodeType === Node.ELEMENT_NODE) {
                    // 5a. Mise à jour des attributs
                    patchAttributes(oldNode, newNode);

                    // 5b. Cas spécifique: Input Value & Checked (pour ne pas perdre le focus)
                    if (oldNode.tagName === 'INPUT') {
                        if (oldNode.type === 'checkbox') {
                            if (oldNode.checked !== newNode.checked) oldNode.checked = newNode.checked;
                        } else if (oldNode.value !== newNode.value && document.activeElement !== oldNode) {
                             // On ne met à jour la valeur que si ce n'est pas l'élément actif en train d'être édité
                            oldNode.value = newNode.value;
                        }
                    }

                    // 5c. Récursion pour les enfants
                    // Optimisation: si innerHTML identique, on ne descend pas (sauf si contient des inputs)
                    if (oldNode.innerHTML === newNode.innerHTML && !oldNode.querySelector('input')) {
                        continue; 
                    }
                    
                    patchNodes(oldNode, Array.from(oldNode.childNodes), Array.from(newNode.childNodes));
                }
            }
        }

        function patchAttributes(oldEl, newEl) {
            // Supprimer les attributs qui n'existent plus
            Array.from(oldEl.attributes).forEach(attr => {
                if (!newEl.hasAttribute(attr.name)) {
                    oldEl.removeAttribute(attr.name);
                }
            });
            // Ajouter ou mettre à jour les attributs
            Array.from(newEl.attributes).forEach(attr => {
                if (oldEl.getAttribute(attr.name) !== attr.value) {
                    // Petit hack pour éviter le flicker des images/icônes si src/class identique
                    oldEl.setAttribute(attr.name, attr.value);
                }
            });
            // Cas spécial pour 'value' sur les inputs qui n'est pas toujours un attribut
            if (newEl.tagName === 'INPUT') {
                 if (newEl.hasAttribute('value')) {
                     oldEl.setAttribute('value', newEl.getAttribute('value'));
                 }
            }
        }

        function renderApp() {
            renderHeader();
            renderContent();
        }

        function renderHeader() {
            const tabs = [
                { id: 0, title: "1. Sélection", icon: "assignment" },
                { id: 1, title: "2. Priorisation", icon: "format_list_numbered" },
                { id: 2, title: "3. Positionnement", icon: "bar_chart" },
                { id: 3, title: "4. Plan", icon: "calendar_today" }
            ];

            const html = `
                <div class="max-w-5xl mx-auto">
                    <div class="flex flex-col md:flex-row items-center justify-between px-4 py-4 md:py-0 md:h-20 gap-4">
                        <div class="flex items-center gap-3 shrink-0 self-start md:self-auto pt-2 md:pt-0">
                            <div class="p-2 bg-slate-800 rounded-lg shadow-sm text-white flex items-center justify-center">
                                ${getIconHtml('chat_bubble', 'icon-lg')}
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-slate-600 uppercase tracking-wide mb-0.5">Entretien de découverte</p>
                                <h1 class="text-xl font-bold leading-none text-slate-900">Automatique</h1>
                            </div>
                        </div>

                        <nav class="flex items-center gap-1 md:gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 hide-scrollbar">
                            ${tabs.map((tab, idx) => {
                                const isActive = state.activeTab === idx;
                                const isCompleted = state.activeTab > idx;
                                const buttonClass = isActive 
                                    ? 'bg-slate-800 text-white shadow-md' 
                                    : isCompleted 
                                        ? 'bg-slate-200 text-slate-700 hover:bg-slate-300' 
                                        : 'text-slate-500 hover:bg-slate-100';
                                
                                return `
                                <button
                                    onclick="actions.setActiveTab(${tab.id})"
                                    class="flex items-center gap-2 px-3 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap ${buttonClass}"
                                >
                                    ${getIconHtml(tab.icon, 'icon-sm')}
                                    <span class="${isActive ? 'inline' : 'hidden md:inline'}">${tab.title}</span>
                                    ${idx === 0 && state.selectedSkills.length > 0 ? `
                                        <span class="ml-1 text-[10px] px-1.5 rounded-full ${isActive ? 'bg-white text-slate-800' : 'bg-slate-300 text-slate-800'}">
                                            ${state.selectedSkills.length}
                                        </span>
                                    ` : ''}
                                </button>
                                `;
                            }).join('')}
                        </nav>
                    </div>
                </div>
            `;
            
            renderDOM('app-header', html);
        }

        function renderContent() {
            let html = '';
            switch (state.activeTab) {
                case 0: html = generateSelectionHTML(); break;
                case 1: html = generatePrioritizationHTML(); break;
                case 2: html = generatePositioningHTML(); break;
                case 3: html = generatePlanHTML(); break;
            }
            renderDOM('app-content', html);
        }

        // --- GENERATEURS HTML ---

        function generateSelectionHTML() {
            const activePreset = PRESETS.find(preset => 
                state.selectedSkills.length === preset.skills.length && 
                preset.skills.every(id => state.selectedSkills.includes(id))
            );

            return `
            <div class="fade-in">
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm mb-6 sticky top-4 z-20 flex flex-col gap-4">
                    <div class="flex flex-col md:flex-row gap-3 items-center w-full">
                        <div class="relative flex-grow w-full">
                            <span class="absolute left-3 top-2.5 text-slate-400 pointer-events-none">
                                ${getIconHtml('search', 'icon-xs')}
                            </span>
                            <input
                                type="text"
                                oninput="actions.setSearchQuery(this.value)"
                                value="${state.searchQuery}"
                                class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500 bg-slate-50"
                                placeholder="Rechercher une compétence..."
                            />
                        </div>
                        <div class="flex gap-2 shrink-0 self-end md:self-auto">
                            <button onclick="actions.expandAll()" class="text-xs font-medium px-3 py-2 bg-slate-100 text-slate-600 rounded-md hover:bg-slate-200 transition-colors whitespace-nowrap">Tout ouvrir</button>
                            <button onclick="actions.collapseAll()" class="text-xs font-medium px-3 py-2 bg-slate-100 text-slate-600 rounded-md hover:bg-slate-200 transition-colors whitespace-nowrap">Tout réduire</button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 overflow-x-auto pb-1 hide-scrollbar border-t border-slate-100 pt-3 w-full">
                        ${PRESETS.map(preset => {
                            const isPresetActive = state.selectedSkills.length === preset.skills.length && preset.skills.every(id => state.selectedSkills.includes(id));
                            const btnClass = isPresetActive 
                                ? 'bg-slate-800 text-white border-slate-800 shadow-sm' 
                                : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:border-slate-400';
                            
                            return `
                            <button
                                onclick="actions.applyPreset('${preset.id}')"
                                class="px-3 py-1.5 rounded-full text-xs font-medium border transition-colors whitespace-nowrap flex items-center gap-1.5 ${btnClass}"
                            >
                                ${preset.label}
                            </button>
                            `;
                        }).join('')}
                    </div>

                    ${activePreset ? `
                        <div class="bg-slate-50 rounded-lg p-3 border border-slate-200 fade-in">
                            <p class="text-sm text-slate-600 leading-relaxed">${activePreset.description}</p>
                        </div>
                    ` : ''}
                </div>

                <div class="space-y-4">
                    ${SKILLS_DATA.map(generateCategoryHTML).join('')}
                </div>
            </div>
            `;
        }

        function generateCategoryHTML(category) {
            const lowerQuery = state.searchQuery.toLowerCase();
            const subMatch = category.subSkills.filter(sub => 
                sub.title.toLowerCase().includes(lowerQuery) || 
                sub.description.toLowerCase().includes(lowerQuery) ||
                category.title.toLowerCase().includes(lowerQuery)
            );
            
            if (state.searchQuery && subMatch.length === 0) return ''; 

            const filteredSubSkills = state.searchQuery ? subMatch : category.subSkills;
            
            const allVisibleSelected = filteredSubSkills.length > 0 && filteredSubSkills.every(s => state.selectedSkills.includes(s.id));
            const isExpanded = state.searchQuery ? true : !!state.expandedCategories[category.id];

            // CALCUL DU NOMBRE DE COMPÉTENCES SÉLECTIONNÉES
            const selectedCount = category.subSkills.filter(sub => state.selectedSkills.includes(sub.id)).length;

            return `
            <div class="border rounded-lg bg-white shadow-sm mb-3 overflow-hidden border-slate-200">
                <div 
                    onclick="actions.toggleCategory('${category.id}')"
                    class="w-full flex items-center justify-between p-4 cursor-pointer transition-colors ${isExpanded ? 'bg-slate-50' : 'bg-white hover:bg-slate-50'}"
                >
                    <div class="flex items-center gap-4 max-w-[85%]">
                        <div onclick="event.stopPropagation(); actions.toggleAllInCategory('${category.id}', ${!allVisibleSelected})" class="cursor-pointer z-10 p-1 flex items-center justify-center">
                            <input type="checkbox" ${allVisibleSelected ? 'checked' : ''} class="w-5 h-5 cursor-pointer accent-slate-800" />
                        </div>
                        <div class="p-2 rounded-md ${isExpanded ? 'bg-slate-200 text-slate-800' : 'bg-slate-100 text-slate-500'} flex items-center justify-center">
                            ${getIconHtml(category.icon, 'icon-md')}
                        </div>
                        <div>
                            <h2 class="font-semibold text-lg ${isExpanded ? 'text-slate-900' : 'text-slate-700'} flex items-center">
                                ${category.title}
                                ${selectedCount > 0 ? `
                                    <span class="ml-2 inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-200 text-slate-700 text-[10px] font-bold leading-none">
                                        ${selectedCount}
                                    </span>
                                ` : ''}
                            </h2>
                            ${!isExpanded ? `<p class="text-sm text-slate-500 hidden sm:block">${category.description}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-slate-400 flex items-center">
                        ${getIconHtml(isExpanded ? 'expand_more' : 'chevron_right', 'icon-md')}
                    </div>
                </div>

                ${isExpanded ? `
                <div class="p-4 pt-2 border-t border-slate-100 bg-slate-50/50">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${filteredSubSkills.map(sub => {
                            const isSelected = state.selectedSkills.includes(sub.id);
                            const itemClass = isSelected 
                                ? 'bg-slate-100 border-slate-500 ring-1 ring-slate-200' 
                                : 'bg-white border-slate-200 hover:border-slate-400 hover:shadow-sm';
                            
                            return `
                            <div 
                                onclick="actions.toggleSkill('${sub.id}')"
                                class="cursor-pointer border rounded-lg p-3 transition-all duration-200 flex items-start gap-3 relative ${itemClass}"
                            >
                                <div class="mt-0.5 flex-shrink-0">
                                    <input type="checkbox" ${isSelected ? 'checked' : ''} class="w-4 h-4 accent-slate-800 pointer-events-none" />
                                </div>
                                <div>
                                    <h3 class="text-sm font-semibold mb-1 text-slate-800">${sub.title.replace(/^\d+\.\d+\.\s/, '')}</h3>
                                    <p class="text-xs text-slate-500 line-clamp-2">${sub.description}</p>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
            `;
        }

        function generatePrioritizationHTML() {
            if (state.selectedSkills.length === 0) return `
                <div class="text-center py-20 bg-white rounded-lg border border-slate-200 border-dashed slide-in">
                    <p class="text-slate-500">Aucune compétence sélectionnée.</p>
                    <button onclick="actions.setActiveTab(0)" class="text-slate-800 font-medium mt-2 hover:underline">Retourner à la sélection</button>
                </div>
            `;

            const skills = getResolvedSelectedSkills();

            return `
            <div class="slide-in">
                <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm mb-6">
                    <div class="space-y-5">
                        <div>
                            <label class="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-wide mb-3">
                                ${getIconHtml('factory', 'icon-xs')} Écosystèmes Constructeurs
                            </label>
                            <div class="flex flex-wrap gap-2">
                                ${MANUFACTURER_OPTIONS.map(opt => `
                                <button onclick="actions.togglePreference('manufacturers', '${opt}')"
                                    class="px-3 py-1.5 rounded-md text-sm transition-all border ${state.preferences.manufacturers.includes(opt) ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100'}">
                                    ${opt}
                                </button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-wide mb-3">
                                ${getIconHtml('security', 'icon-xs')} Secteurs Cibles
                            </label>
                            <div class="flex flex-wrap gap-2">
                                ${SECTOR_OPTIONS.map(opt => `
                                <button onclick="actions.togglePreference('sectors', '${opt}')"
                                    class="px-3 py-1.5 rounded-md text-sm transition-all border ${state.preferences.sectors.includes(opt) ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100'}">
                                    ${opt}
                                </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-2 mt-6">
                    <h3 class="font-semibold text-slate-700">Ordre de priorité des compétences</h3>
                    <span class="text-xs text-slate-400">Utiliser les flèches</span>
                </div>

                <div class="space-y-2">
                    ${skills.map((skill, index) => `
                    <div class="bg-white p-3 border border-slate-200 rounded-lg shadow-sm flex items-center justify-between group hover:border-slate-400 transition-colors">
                        <div class="flex items-center gap-4 overflow-hidden">
                            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-slate-500 font-bold text-xs shrink-0">${index + 1}</span>
                            <div class="min-w-0">
                                <h4 class="font-semibold text-slate-800 truncate">${skill.title}</h4>
                                <div class="flex items-center gap-1.5 text-xs text-slate-500">
                                    <span class="text-slate-400 inline-flex align-middle">${getIconHtml(skill.categoryIcon, 'icon-xs')}</span>
                                    <span class="truncate ml-1">${skill.categoryTitle.replace(/^\d+\.\s*/, '')}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 shrink-0">
                            <button onclick="actions.moveSkill(${index}, -1)" ${index === 0 ? 'disabled' : ''} class="p-1.5 hover:bg-slate-100 rounded text-slate-500 disabled:opacity-30 disabled:cursor-not-allowed flex items-center">${getIconHtml('arrow_upward', 'icon-sm')}</button>
                            <button onclick="actions.moveSkill(${index}, 1)" ${index === skills.length - 1 ? 'disabled' : ''} class="p-1.5 hover:bg-slate-100 rounded text-slate-500 disabled:opacity-30 disabled:cursor-not-allowed flex items-center">${getIconHtml('arrow_downward', 'icon-sm')}</button>
                            <div class="w-px h-4 bg-slate-200 mx-1"></div>
                            <button onclick="actions.toggleSkill('${skill.id}')" class="p-1.5 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded transition-colors flex items-center">${getIconHtml('delete', 'icon-sm')}</button>
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>
            `;
        }

        function generatePositioningHTML() {
            if (state.selectedSkills.length === 0) return '<div class="text-center py-20"><p class="text-slate-500">Aucune compétence sélectionnée.</p></div>';
            
            const skills = getResolvedSelectedSkills();
            
            return `
            <div class="slide-in space-y-6">
                ${skills.map(skill => {
                    const currentLevel = state.skillLevels[skill.id] || 0;
                    return `
                    <div class="bg-white p-5 border border-slate-200 rounded-lg shadow-sm">
                        <div class="mb-4">
                            <h4 class="font-bold text-slate-800 text-lg">${skill.title}</h4>
                            <p class="text-sm text-slate-500">${skill.description}</p>
                        </div>
                        <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${LEVEL_DETAILS.map((level, idx) => {
                                const isSelected = currentLevel === idx;
                                const btnClass = isSelected 
                                    ? 'bg-slate-800 border-slate-800 text-white shadow-md scale-105 z-10' 
                                    : 'bg-white border-slate-200 text-slate-600 hover:border-slate-400 hover:bg-slate-50';
                                return `
                                <button onclick="actions.updateLevel('${skill.id}', ${idx})" class="relative flex flex-col items-center justify-center p-3 rounded-lg border-2 transition-all duration-200 text-center ${btnClass}">
                                    <div class="text-xs font-bold uppercase tracking-wider mb-1 ${isSelected ? 'text-slate-300' : 'text-slate-400'}">Niveau ${idx}</div>
                                    <div class="font-bold text-sm mb-1 ${isSelected ? 'text-white' : 'text-slate-800'}">${level.label}</div>
                                    <div class="text-[10px] ${isSelected ? 'text-slate-300' : 'text-slate-500'}">${level.hours}</div>
                                </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    `;
                }).join('')}
            </div>
            `;
        }

        function generatePlanHTML() {
            const durationEstimate = calculateDuration();

            return `
            <div class="slide-in max-w-2xl mx-auto">
                <div class="bg-white p-8 border border-slate-200 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Planification</h2>
                    
                    <div class="space-y-8">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-3">Période de disponibilité souhaitée</label>
                            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                                ${MONTHS.map((month, idx) => {
                                    const isSelected = state.logistics.selectedMonths.includes(idx);
                                    const btnClass = isSelected 
                                        ? 'bg-slate-800 border-slate-800 text-white font-medium shadow-sm' 
                                        : 'bg-white border-slate-200 text-slate-600 hover:border-slate-400 hover:bg-slate-50';
                                    return `
                                    <button onclick="actions.toggleMonth(${idx})" class="py-2 px-1 text-sm rounded-lg border transition-all duration-200 ${btnClass}">
                                        ${month}
                                    </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-3">Rythme Hebdomadaire</label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                                ${PACE_OPTIONS.map(opt => {
                                    const isSelected = state.logistics.weeklyHours === opt.value;
                                    const btnClass = isSelected 
                                        ? 'bg-slate-800 border-slate-800 text-white shadow-md scale-105 z-10' 
                                        : 'bg-white border-slate-200 text-slate-700 hover:border-slate-400 hover:bg-slate-50';
                                    return `
                                    <button onclick="actions.setLogistics('weeklyHours', ${opt.value})" class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 ${btnClass}">
                                        <span class="text-sm font-bold leading-tight">${opt.label}</span>
                                        <span class="text-[11px] font-medium mt-1 ${isSelected ? 'text-slate-300' : 'text-slate-500'}">${opt.sub}</span>
                                    </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-3">Format envisageable</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                ${FORMAT_OPTIONS.map(opt => {
                                    const isSelected = state.logistics.format === opt.value;
                                    const btnClass = isSelected 
                                        ? 'bg-slate-800 border-slate-800 text-white shadow-md scale-105 z-10' 
                                        : 'bg-white border-slate-200 text-slate-700 hover:border-slate-400 hover:bg-slate-50';
                                    return `
                                    <button onclick="actions.setLogistics('format', '${opt.value}')" class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 ${btnClass}">
                                        <span class="text-sm font-bold leading-tight">${opt.label}</span>
                                        <span class="text-[11px] font-medium mt-1 ${isSelected ? 'text-slate-300' : 'text-slate-500'}">${opt.sub}</span>
                                    </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="pt-6 border-t border-slate-100">
                            <h3 class="font-semibold text-slate-900 mb-3">Récapitulatif Préliminaire</h3>
                            <ul class="space-y-2 text-sm text-slate-600 bg-slate-50 p-4 rounded-lg">
                                <li class="flex justify-between">
                                    <span>Compétences ciblées :</span>
                                    <span class="font-medium text-slate-900">${state.selectedSkills.length}</span>
                                </li>
                                <li class="flex justify-between items-start">
                                    <span>Période :</span>
                                    <span class="font-medium text-slate-900 text-right max-w-[60%]">
                                        ${state.logistics.selectedMonths.length > 0 
                                            ? state.logistics.selectedMonths.sort((a,b)=>a-b).map(i => MONTHS[i]).join(', ') 
                                            : 'Non définie'}
                                    </span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Volume Hebdo :</span>
                                    <span class="font-medium text-slate-900">${state.logistics.weeklyHours ? state.logistics.weeklyHours + 'h' : 'Non défini'}</span>
                                </li>
                                <li class="flex justify-between border-t border-slate-200 pt-2 mt-2">
                                    <span class="text-slate-800 font-medium">Durée estimée :</span>
                                    <span class="font-bold text-slate-800">${durationEstimate || '...'}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }


        // --- 6. ACTIONS (EVENT HANDLERS) ---
        // Toutes les actions redéclenchent le rendu, mais le diffing ne changera que le nécessaire
        const actions = {
            setActiveTab: (tabId) => { state.activeTab = tabId; renderApp(); },
            setSearchQuery: (query) => { state.searchQuery = query; renderApp(); },
            expandAll: () => { SKILLS_DATA.forEach(c => state.expandedCategories[c.id] = true); renderApp(); },
            collapseAll: () => { state.expandedCategories = {}; renderApp(); },
            toggleCategory: (id) => { state.expandedCategories[id] = !state.expandedCategories[id]; renderApp(); },
            toggleSkill: (id) => {
                if (state.selectedSkills.includes(id)) {
                    state.selectedSkills = state.selectedSkills.filter(s => s !== id);
                } else {
                    state.selectedSkills.push(id);
                }
                renderApp();
            },
            toggleAllInCategory: (catId, shouldAdd) => {
                const category = SKILLS_DATA.find(c => c.id === catId);
                const ids = category.subSkills.map(s => s.id);
                if (shouldAdd) {
                    const newIds = ids.filter(id => !state.selectedSkills.includes(id));
                    state.selectedSkills = [...state.selectedSkills, ...newIds];
                } else {
                    state.selectedSkills = state.selectedSkills.filter(id => !ids.includes(id));
                }
                renderApp();
            },
            applyPreset: (presetId) => {
                const preset = PRESETS.find(p => p.id === presetId);
                const isActive = state.selectedSkills.length === preset.skills.length && preset.skills.every(id => state.selectedSkills.includes(id));
                state.selectedSkills = isActive ? [] : [...preset.skills];
                renderApp();
            },
            togglePreference: (type, value) => {
                const list = state.preferences[type];
                if (list.includes(value)) state.preferences[type] = list.filter(v => v !== value);
                else state.preferences[type].push(value);
                renderApp();
            },
            moveSkill: (index, dir) => {
                if ((dir === -1 && index === 0) || (dir === 1 && index === state.selectedSkills.length - 1)) return;
                const item = state.selectedSkills.splice(index, 1)[0];
                state.selectedSkills.splice(index + dir, 0, item);
                renderApp();
            },
            updateLevel: (skillId, level) => {
                state.skillLevels[skillId] = level;
                renderApp();
            },
            toggleMonth: (monthIndex) => {
                const list = state.logistics.selectedMonths;
                if (list.includes(monthIndex)) state.logistics.selectedMonths = list.filter(m => m !== monthIndex);
                else state.logistics.selectedMonths.push(monthIndex);
                renderApp();
            },
            setLogistics: (key, value) => {
                state.logistics[key] = value;
                renderApp();
            }
        };

        // Rendu initial
        renderApp();

    </script>
</body>
</html>
